#!/usr/bin/env bash

# update crontab

set -ETeuo pipefail

declare BASEDIR; BASEDIR="$( cd "$( dirname $0 )/.." && pwd )"

services="$( 
  cd ${BASEDIR}/services 
  ls * | grep ".service" | sed "s/.service//" 
)"

for service in $services; do
  (
    TULS_BASEDIR=${BASEDIR}
    source ${BASEDIR}/services/${service}.service
    # prepare log dir
    mkdir -p ${BASEDIR}/var/log/${service}/
    # prepare status
    mkdir -p ${BASEDIR}/var/exit/${service}/
    # write parent wrapper
    cat > ${BASEDIR}/var/lib/${service} << EOI
#!/usr/bin/env bash

nice $NICE ionice $IONICE ${BASEDIR}/var/lib/${service}_child
EOI
  # write child wrappter
  cat > ${BASEDIR}/var/lib/${service}_child << EOI
#!/usr/bin/env bash

# make sure service is runing only once
pid_fn=${BASEDIR}/run/pids/${service}

# create run dir
if [ ! -e ${BASEDIR}/run ]; then
  mkdir -p /tmp/tuls_run_${USER}
  ln -s /tmp/tuls_run_${USER} ${BASEDIR}/run
fi
if [ -f "\$pid_fn" ] && kill -0 \$(cat \$pid_fn) 2>/dev/null; then
  printf "\$0: already running (\"\${pid_fn}\")\n" >&2; exit 0;
fi
echo \$BASHPID > \$pid_fn

# cleanup on exit
trap "rm \$pid_fn" INT TERM EXIT

rm -f ${BASEDIR}/var/log/${service}/
${BASEDIR}/bin/rotate ${BASEDIR}/var/exit/${service}/exit_code
export TULS_BASEDIR=${BASEDIR}
export TULS_PATH=${BASEDIR}/3rdparty/busybox/bin/:${BASEDIR}/3rdparty/busybox/sbin/:${BASEDIR}/3rdparty/busybox/usr/bin/:${BASEDIR}/3rdparty/busybox/usr/sbin/
{
  {
    echo \$BASHPID > \$pid_fn   # some subshell was created by now
    $EXECSTART
  } 2>&1
  # write exit code
  echo \$? > ${BASEDIR}/var/exit/${service}/exit_code
} | ${BASEDIR}/3rdparty/busybox/usr/sbin/svlogd -tt ${BASEDIR}/var/log/${service}/

EOI
    chmod +x ${BASEDIR}/var/lib/${service}
    chmod +x ${BASEDIR}/var/lib/${service}_child
  )
done

printf "writing crontab:\n\n"
{
  printf "TULS_SRVDIR=${BASEDIR}/var/lib/\n"
  for service in $services; do
    (
      TULS_BASEDIR=${BASEDIR}
      source ${BASEDIR}/services/${service}.service
      echo "${TIMER} \${TULS_SRVDIR}/${service}"
    )
  done 
} | tee /dev/fd/2 | crontab -
