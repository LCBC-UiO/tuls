<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="../css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/stat.css">
  <title>Status</title>
</head>
<body>
  <div class="container mt-3">
    <h1>Service status</h1>
    <span>updated: </span><span id="updatedOn"></span>
    <div>
      <table id="statusTable" class="table"><tr><th>please</th></tr><tr><td>wait</td></tr></table>
    </div>
  </div>
  <script>
    async function getData(url) {
      const response = await fetch(url, {
        method: 'GET'
      });
      return response.json();
    }

    function getStatusIcon(str) {
      if (str == "running") return "&#x1F7E2";
      if (str == "stopped") return "&#x1F7E9";
      if (str.startsWith('error')) return "&#x1F7E5"; 	
      //"&#x1F7E5"
      return "&#x2B1C";
    }

    async function update() {
      const stat_json = await getData('./get_status_json.cgi');
      // clear table
      if (stat_json.length == 0) {
        return;
      }
      var table = document.querySelector('#statusTable');
      table.innerHTML = '';

      // header
      {
        var tr = document.createElement("tr");
        // icon
        var th = document.createElement("th");
        tr.appendChild(th);
        for (let [key, value] of Object.entries(stat_json[0])) {
          var th = document.createElement("th");
          th.innerHTML = key;
          tr.appendChild(th);
        }
        table.appendChild(tr);
      }
      stat_json.forEach(e => {
        var tr = document.createElement("tr");
        // icon
        var td = document.createElement("td");
        td.innerHTML = getStatusIcon(e['status']);
        tr.appendChild(td);
        for (let [key, value] of Object.entries(e)) {
          var td = document.createElement("td");
          td.innerHTML = value;
          tr.appendChild(td);
        }
        table.appendChild(tr);
      });
      document.querySelector('#updatedOn').innerHTML = (new Date()).toLocaleString();
    }

    async function doStuff() {
      update();
      setInterval(update, 5000);
    }
    
    doStuff();
  </script>
</body>
</html>
